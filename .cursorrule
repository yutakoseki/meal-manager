# ====================================================================
#  .cursorrule  ── Vottia AI Maestro コーディング規約
# ====================================================================

###############################################################################
# 1. プロジェクト概要
###############################################################################
- **プロジェクト名**: Vottia AI Maestro
- **概要**: Twilio × OpenAI Realtime API を使用した低遅延 Voice Bot システム
- **アーキテクチャ**: モノレポ構成（フロントエンド + バックエンド）

###############################################################################
# 2. プロジェクト構造
###############################################################################
```
vottia-ai-maestro/
├── frontend/     # Next.js フロントエンド
├── frontend/      # WebSocket サーバー（Node.js/TypeScript）
├── trans-AI-Training/           # 別システム参考用
├── package.json                 # ルートワークスペース設定
└── .cursorrule                  # このファイル
```

###############################################################################
# 3. 技術スタック
###############################################################################
## 3.1 フロントエンド (frontend)
- **フレームワーク**: Next.js 14.2.5 (App Router)
- **言語**: TypeScript 5.8.3
- **スタイリング**: Tailwind CSS 3.4.1
- **状態管理**: Jotai 2.12.5
- **UI ライブラリ**: Radix UI + Lucide React
- **パッケージマネージャー**: pnpm 10.12.1
- **認証**: Amazon Cognito
- **データベース**: DynamoDB (AWS SDK v3)

## 3.2 バックエンド (frontend)
- **ランタイム**: Node.js + TypeScript
- **フレームワーク**: Express.js 4.21.2
- **WebSocket**: ws 8.18.0
- **データベース**: DynamoDB (AWS SDK v3)
- **開発環境**: nodemon + ts-node

## 3.3 共通
- **パッケージマネージャー**: pnpm
- **リンター**: ESLint
- **フォーマッター**: Prettier
- **Git Hooks**: Husky + lint-staged

###############################################################################
# 4. コーディング規約
###############################################################################
## 4.1 TypeScript 規約
- **strict モード**: 必須
- **any 型**: 禁止（型安全性を重視）
- **型推論**: 積極的に活用
- **型定義**: 明示的に記述
- **インポート**: 相対パスを使用（@/* エイリアス可）

## 4.2 ファイル命名規則
- **コンポーネント**: PascalCase (例: `UserProfile.tsx`)
- **ページ**: kebab-case (例: `user-profile/page.tsx`)
- **ユーティリティ**: camelCase (例: `formatDate.ts`)
- **定数**: UPPER_SNAKE_CASE (例: `API_ENDPOINTS.ts`)
- **型定義**: PascalCase (例: `UserTypes.ts`)

## 4.3 ディレクトリ構造
### フロントエンド
```
app/
├── (auth)/              # 認証関連ページ
├── admin/               # 管理者ページ
├── api/                 # API ルート
├── user/                # ユーザーページ
├── components/          # 再利用可能コンポーネント
├── lib/                 # ユーティリティ関数
└── contexts/            # React Context
```

### バックエンド
```
src/
├── dynamodb/           # DynamoDB 関連
├── types.ts            # 型定義
├── server.ts           # メインサーバー
└── sessionManager.ts   # セッション管理
```

## 4.4 コメント規約
- **言語**: 日本語
- **関数**: JSDoc 形式で必須
- **複雑なロジック**: 行コメントで説明

```typescript
/**
 * ユーザー情報を取得する
 * @param userId - ユーザーID
 * @returns ユーザー情報オブジェクト
 */
async function getUserInfo(userId: string): Promise<UserInfo> {
  // DynamoDBからユーザー情報を取得
  const result = await dynamoClient.getItem({
    TableName: 'Users',
    Key: { id: userId }
  })
  
  return result.Item as UserInfo
}
```

## 4.5 ログ出力規約
- **言語**: 日本語
- **レベル**: 適切なログレベルを使用
- **構造化**: JSON 形式で出力
- **機密情報**: マスク処理を実施
- 永久に残しておくログは先頭に✅をつけているので削除しないこと。
- 一時的なログは先頭に🔍をつけること。

```typescript
// ✅ 良い例
console.log('✅ ユーザー認証成功', { userId: 'user123', timestamp: new Date() })

// ❌ 悪い例
console.log('User authenticated', { password: 'secret123' })
```

###############################################################################
# 5. コード品質
###############################################################################
## 5.1 ESLint 設定
- **基本設定**: `next/core-web-vitals`
- **追加ルール**: Prettier との競合回避
- **自動修正**: `pnpm lint --fix`

## 5.2 Prettier 設定
```json
{
  "semi": false,
  "singleQuote": true,
  "tabWidth": 2,
  "trailingComma": "es5",
  "printWidth": 100,
  "bracketSpacing": true,
  "arrowParens": "always"
}
```

## 5.3 Git Hooks
- **pre-commit**: lint-staged で自動フォーマット
- **対象ファイル**: TypeScript/JavaScript ファイルのみ

###############################################################################
# 6. セキュリティ規約
###############################################################################
## 6.1 環境変数
- **機密情報**: `.env.local` で管理
- **公開情報**: `.env.example` でテンプレート提供
- **本番環境**: AWS Secrets Manager を使用

## 6.2 入力検証
- **型チェック**: TypeScript で静的検証
- **ランタイム検証**: Zod などのスキーマ検証
- **SQL インジェクション**: パラメータ化クエリ使用

## 6.3 認証・認可
- **認証**: Amazon Cognito を使用
- **認可**: JWT トークンで権限管理
- **セッション**: 適切な有効期限設定

###############################################################################
# 7. パフォーマンス規約
###############################################################################
## 7.1 フロントエンド
- **画像最適化**: Next.js Image コンポーネント使用
- **コード分割**: 動的インポート活用
- **キャッシュ**: 適切なキャッシュ戦略

## 7.2 バックエンド
- **コネクション管理**: プール化
- **非同期処理**: async/await 使用
- **メモリ管理**: 適切なガベージコレクション

###############################################################################
# 8. テスト規約
###############################################################################
## 8.1 テスト方針
- **単体テスト**: ユーティリティ関数
- **統合テスト**: API エンドポイント
- **E2E テスト**: 重要なユーザーフロー

## 8.2 テストファイル命名
- **単体テスト**: `*.test.ts`
- **統合テスト**: `*.spec.ts`
- **E2E テスト**: `*.e2e.ts`

###############################################################################
# 9. デプロイメント規約
###############################################################################
## 9.1 環境管理
- **開発環境**: ローカル開発
- **ステージング環境**: テスト用
- **本番環境**: AWS インフラ

## 9.2 CI/CD
- **ビルド**: pnpm を使用
- **テスト**: 自動実行
- **デプロイ**: AWS Amplify

###############################################################################
# 10. ドキュメント規約
###############################################################################
## 10.1 README
- **プロジェクト概要**: 目的と技術スタック
- **セットアップ手順**: 環境構築方法
- **開発ガイド**: 開発フロー

## 10.2 API ドキュメント
- **OpenAPI**: Swagger/OpenAPI 仕様
- **エンドポイント**: 詳細な説明
- **エラーレスポンス**: エラーコード一覧

###############################################################################
# 11. トラブルシューティング
###############################################################################
## 11.1 よくある問題
- **型エラー**: `strict: true` の影響
- **ビルドエラー**: 依存関係の競合
- **デプロイエラー**: 環境変数の不足

## 11.2 デバッグ方法
- **ログ確認**: CloudWatch Logs
- **型チェック**: `pnpm type-check`
- **リンター**: `pnpm lint`

# EOF